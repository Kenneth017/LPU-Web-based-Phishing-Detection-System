{% extends "base.html" %}

{% block title %}Email Analysis Result - Cyber Phishing Detection{% endblock %}

{% block content %}
<div class="email-analysis-result">
    <h1>Email Analysis Result</h1>
    
    <div class="result-card {% if result.is_phishing %}phishing{% else %}safe{% endif %}">
        <div class="result-header">
            <h2>Verdict: {{ "Potential Phishing" if result.is_phishing else "Likely Safe" }}</h2>
            <div class="confidence-meter">
                <div class="meter-fill {{ result.explanation.confidence_level|lower }}"
                     style="width: {{ result.confidence * 100 }}%;">
                </div>
            </div>
            <span class="confidence-text">
                Confidence: {{ "%.1f"|format(result.confidence * 100) }}% 
                ({{ result.explanation.confidence_level }} Confidence)
            </span>
        </div>
        
        <div class="result-content">
            <h3>Summary</h3>
            <p>
                {% if result.is_phishing %}
                    This email shows characteristics often associated with phishing attempts. Please exercise caution.
                {% else %}
                    This email appears to be legitimate, but always remain vigilant.
                {% endif %}
            </p>

            {% if result.features.is_service_email %}
            <div class="service-email-notice">
                <h3>Service Email Detection</h3>
                <p>This appears to be a legitimate service email from a verified sender.</p>
            </div>
            {% endif %}
            
            <h3>Risk Assessment</h3>
            <div class="risk-assessment">
                <div class="risk-category">
                    <strong>URL Risk:</strong>
                    <span class="risk-level {{ result.explanation.risk_assessment.url_risk|lower }}">
                        {{ result.explanation.risk_assessment.url_risk }}
                    </span>
                </div>
                <div class="risk-category">
                    <strong>Content Risk:</strong>
                    <span class="risk-level {{ result.explanation.risk_assessment.content_risk|lower }}">
                        {{ result.explanation.risk_assessment.content_risk }}
                    </span>
                </div>
                <div class="risk-category">
                    <strong>Structure Risk:</strong>
                    <span class="risk-level {{ result.explanation.risk_assessment.structure_risk|lower }}">
                        {{ result.explanation.risk_assessment.structure_risk }}
                    </span>
                </div>
            </div>
            
            <h3>Key Findings</h3>
            <ul class="key-findings">
                <li>
                    <strong>Email Structure:</strong> 
                    {% if result.features.has_greeting and result.features.has_signature %}
                        Contains proper greeting and signature (Good sign)
                    {% else %}
                        Missing proper greeting or signature (Potential red flag)
                    {% endif %}
                </li>
                <li>
                    <strong>Links:</strong> 
                    {% if result.embedded_links|default([])|length == 0 %}
                        No links found in the email (Good sign)
                    {% else %}
                        Contains {{ result.embedded_links|length }} link(s), 
                        {% set suspicious_count = result.embedded_links|selectattr('suspicious', 'eq', true)|list|length %}
                        {% if suspicious_count > 0 %}
                            including {{ suspicious_count }} suspicious link(s) (Potential red flag)
                        {% else %}
                            none of which appear suspicious (Good sign)
                        {% endif %}
                    {% endif %}
                </li>
                <li>
                    <strong>Urgent Language:</strong>
                    {% if result.features.contains_urgent or result.features.urgent_count > 0 %}
                        Contains urgent or time-sensitive language (Potential red flag)
                    {% else %}
                        No urgent or time-sensitive language detected (Good sign)
                    {% endif %}
                </li>
                <li>
                    <strong>Sensitive Information Requests:</strong>
                    {% if result.features.contains_personal or result.features.contains_financial %}
                        Requests for personal or financial information detected (Potential red flag)
                    {% else %}
                        No requests for sensitive information detected (Good sign)
                    {% endif %}
                </li>
                <li>
                    <strong>Attachments:</strong>
                    {% if result.attachments|default([])|length > 0 %}
                        Contains {{ result.attachments|length }} attachment(s) (Exercise caution)
                    {% else %}
                        No attachments found
                    {% endif %}
                </li>
                {% if result.features.is_service_email %}
                <li>
                    <strong>Service Email Indicators:</strong>
                    <ul>
                        {% if result.features.has_account_info %}
                        <li>Contains expected account information (Good sign)</li>
                        {% endif %}
                        {% if result.features.has_company_signature %}
                        <li>Contains valid company signature (Good sign)</li>
                        {% endif %}
                        {% if result.features.has_personal_greeting %}
                        <li>Contains personalized greeting (Good sign)</li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}
            </ul>

            <div class="detailed-indicators">
                <h3>Analysis Indicators</h3>
                <div class="indicators-section">
                    <h4>Suspicious Indicators</h4>
                    <ul class="suspicious-indicators">
                        {% for indicator in result.explanation.suspicious_indicators %}
                        <li class="indicator-item">
                            <span class="indicator-icon suspicious">⚠️</span>
                            {{ indicator }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="indicators-section">
                    <h4>Safe Indicators</h4>
                    <ul class="safe-indicators">
                        {% for indicator in result.explanation.safe_indicators %}
                        <li class="indicator-item">
                            <span class="indicator-icon safe">✓</span>
                            {{ indicator }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            
            <h3>Recommendations</h3>
            <ul class="recommendations">
                {% if result.is_phishing %}
                    <li>Do not click on any links or download any attachments from this email.</li>
                    <li>Do not reply to this email or provide any personal information.</li>
                    <li>If you believe this is from a legitimate sender, contact them through a known, trusted method (not by replying to this email).</li>
                    <li>Report this email to your IT department or email provider as potential phishing.</li>
                {% else %}
                    <li>While this email appears safe, always remain cautious with unexpected emails.</li>
                    <li>If you're unsure about any requests in the email, verify with the sender through a separate, trusted communication channel.</li>
                    <li>Never provide sensitive information unless you're absolutely certain of the recipient's identity.</li>
                {% endif %}
                <li>Keep your software and security systems up to date.</li>
            </ul>
        </div>
    </div>
    
    <div class="email-content-section">
        <h3>Email Details</h3>
        <div class="email-metadata">
            <p><strong>Subject:</strong> {{ result.subject }}</p>
            <p><strong>From:</strong> {{ result.sender }}</p>
            <p><strong>Date:</strong> {{ result.date }}</p>
        </div>

        {% if result.embedded_links|default([]) %}
        <div class="embedded-links-section">
            <h4>Detected URLs ({{ result.embedded_links|length }})</h4>
            <div class="links-table">
                <table>
                    <thead>
                        <tr>
                            <th>Displayed Text</th>
                            <th>Actual URL</th>
                            <th>Risk Level</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for link in result.embedded_links %}
                        <tr class="{{ 'suspicious' if link.suspicious else 'safe' }}">
                            <td>{{ link.text }}</td>
                            <td>
                                <code>{{ link.url }}</code>
                                <br>
                                <small class="text-muted">Length: {{ link.url|length }}</small>
                            </td>
                            <td>
                                <span class="risk-badge {{ 'high-risk' if link.suspicious else 'low-risk' }}">
                                    {{ "Suspicious" if link.suspicious else "Low Risk" }}
                                </span>
                            </td>
                            <td>
                                <details>
                                    <summary>URL Analysis</summary>
                                    <small>
                                        <ul style="margin: 0; padding-left: 20px;">
                                            <li>Protocol: {{ link.url.split('://')[0] }}</li>
                                            <li>Domain: {{ link.url.split('://')[1].split('/')[0] if '://' in link.url else 'N/A' }}</li>
                                            <li>Path: {{ '/' + link.url.split('://')[1].split('/', 1)[1] if '://' in link.url and '/' in link.url.split('://')[1] else 'N/A' }}</li>
                                        </ul>
                                    </small>
                                </details>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if result.attachments|default([]) %}
        <div class="email-attachments">
            <h4>Attachments</h4>
            <table class="attachment-table">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Content Type</th>
                        <th>Hash Values</th>
                    </tr>
                </thead>
                <tbody>
                {% for attachment in result.attachments %}
                    <tr>
                        <td>{{ attachment.filename }}</td>
                        <td>{{ attachment.size|filesizeformat }}</td>
                        <td>{{ attachment.content_type }}</td>
                        <td>
                            <div class="hash-values">
                                <p><strong>MD5:</strong> <code>{{ attachment.hash.md5 }}</code></p>
                                <p><strong>SHA1:</strong> <code>{{ attachment.hash.sha1 }}</code></p>
                                <p><strong>SHA256:</strong> <code>{{ attachment.hash.sha256 }}</code></p>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <div class="email-body-section">
            <h4>Email Content</h4>
            <div class="email-body-container">
                <div class="email-body-tabs">
                    <button class="tab-button active" data-tab="text">Text View</button>
                    {% if result.html_content %}
                    <button class="tab-button" data-tab="html">HTML View</button>
                    {% endif %}
                </div>
                <div class="email-body-content">
                    <div id="text-view" class="tab-content active">
                        <pre class="email-text">{{ result.body }}</pre>
                    </div>
                    {% if result.html_content %}
                    <div id="html-view" class="tab-content">
                        <div class="email-html">
                            {{ result.html_content|safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="actions">
        <a href="{{ url_for('email_analysis') }}" class="btn btn-primary">Analyze Another Email</a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>

    <div class="debug-info" style="display: none;">
        <h3>Debug Information</h3>
        <h4>Email Structure Features</h4>
        <pre>
        Has Greeting: {{ result.features.has_greeting }}
        Has Personal Greeting: {{ result.features.has_personal_greeting }}
        Has Signature: {{ result.features.has_signature }}
        Has Company Signature: {{ result.features.has_company_signature }}
        </pre>
        
        <h4>Content Features</h4>
        <pre>
        Text Length: {{ result.features.text_length }}
        Word Count: {{ result.features.word_count }}
        URL Count: {{ result.features.url_count }}
        Suspicious URLs: {{ result.features.suspicious_url_count }}
        Contains Urgent Language: {{ result.features.contains_urgent }}
        Contains Sensitive Info: {{ result.features.contains_personal or result.features.contains_financial }}
        </pre>
        
        <h4>Full Result</h4>
        <pre>{{ result | tojson(indent=2) }}</pre>
    </div>
</div>
<button id="toggle-debug">Toggle Debug Info</button>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Update active button
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-view`).classList.add('active');
        });
    });
});
document.getElementById('toggle-debug').addEventListener('click', function() {
    var debugInfo = document.querySelector('.debug-info');
    var isHidden = debugInfo.style.display === 'none';
    debugInfo.style.display = isHidden ? 'block' : 'none';
    
    // Save state to localStorage
    localStorage.setItem('debugVisible', isHidden);
});

// Restore debug visibility state on page load
document.addEventListener('DOMContentLoaded', function() {
    var debugInfo = document.querySelector('.debug-info');
    var wasVisible = localStorage.getItem('debugVisible') === 'true';
    if (wasVisible) {
        debugInfo.style.display = 'block';
    }
});
</script>
{% endblock %}
