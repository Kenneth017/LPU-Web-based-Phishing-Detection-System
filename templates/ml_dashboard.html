{% extends "base.html" %}
{% block content %}
<div class="ml-dashboard">
    <div class="dashboard-header">
        <h1>Machine Learning Analytics Dashboard</h1>
        <button id="exportAllData" class="export-btn">
            <i class="fas fa-download"></i> Export Dashboard Data
        </button>
    </div>
    
    <div class="dashboard-grid">
        <!-- Overview Cards -->
        <div class="metric-cards">
            <div class="metric-card">
                <h3>Total Checks</h3>
                <p class="metric-value">{{ basic_metrics.total_checks }}</p>
            </div>
            <div class="metric-card">
                <h3>Detection Rate</h3>
                <p class="metric-value">{{ "%.2f"|format(basic_metrics.detection_rate * 100) }}%</p>
            </div>
            <div class="metric-card">
                <h3>Phishing Detected</h3>
                <p class="metric-value">{{ basic_metrics.phishing_detected }}</p>
            </div>
        </div>

        <!-- ROC Curve -->
        <div class="chart-card" id="rocCurveCard">
            <div class="chart-header">
                <h3>ROC Curve</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="rocCurve" class="chart-content"></div>
        </div>

        <!-- Precision-Recall Curve -->
        <div class="chart-card" id="prCurveCard">
            <div class="chart-header">
                <h3>Precision-Recall Curve</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="prCurve" class="chart-content"></div>
        </div>

        <!-- Feature Importance -->
        <div class="chart-card" id="featureImportanceCard">
            <div class="chart-header">
                <h3>Feature Importance Analysis</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="featureImportance" class="chart-content"></div>
        </div>

        <!-- Model Evolution -->
        <div class="chart-card" id="modelEvolutionCard">
            <div class="chart-header">
                <h3>Model Performance Evolution</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="modelEvolution" class="chart-content"></div>
        </div>

        <!-- Vendor Agreement -->
        <div class="chart-card" id="vendorAgreementCard">
            <div class="chart-header">
                <h3>Vendor Agreement Analysis</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="vendorAgreement" class="chart-content"></div>
        </div>
    </div>

    <!-- Modal for displaying charts -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalChartTitle"></h2>
                <span class="close">&times;</span>
            </div>
            <div id="modalChartContent"></div>
        </div>
    </div>
</div>

<!-- Include Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Store the chart data globally
        let chartData = {
            rocCurve: null,
            prCurve: null,
            featureImportance: null,
            modelEvolution: null,
            vendorAgreement: null
        };

        // Initialize main charts
        function initializeCharts() {
            // [Previous chart initialization code remains the same]
            // ... (keep all your existing chart initialization code)
        }

        // Initialize main charts
        initializeCharts();

        // Export all data function
        function exportAllData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add basic metrics
            csvContent += "Basic Metrics\n";
            csvContent += "Metric,Value\n";
            csvContent += `Total Checks,${{{ basic_metrics.total_checks }}}\n`;
            csvContent += `Detection Rate,${{{ "%.2f"|format(basic_metrics.detection_rate * 100) }}}\n`;
            csvContent += `Phishing Detected,${{{ basic_metrics.phishing_detected }}}\n\n`;

            // Add ROC Curve data
            csvContent += "ROC Curve Data\n";
            csvContent += "False Positive Rate,True Positive Rate\n";
            chartData.rocCurve.data[0].x.forEach((x, i) => {
                csvContent += `${x},${chartData.rocCurve.data[0].y[i]}\n`;
            });
            csvContent += "\n";

            // Add Precision-Recall data
            csvContent += "Precision-Recall Curve Data\n";
            csvContent += "Recall,Precision\n";
            chartData.prCurve.data[0].x.forEach((x, i) => {
                csvContent += `${x},${chartData.prCurve.data[0].y[i]}\n`;
            });
            csvContent += "\n";

            // Add Feature Importance data
            csvContent += "Feature Importance Analysis\n";
            csvContent += "Feature,Importance Score\n";
            chartData.featureImportance.data[0].y.forEach((feature, i) => {
                csvContent += `${feature},${chartData.featureImportance.data[0].x[i]}\n`;
            });
            csvContent += "\n";

            // Add Model Evolution data
            csvContent += "Model Performance Evolution\n";
            csvContent += "Date,Accuracy\n";
            chartData.modelEvolution.data[0].x.forEach((date, i) => {
                csvContent += `${date},${chartData.modelEvolution.data[0].y[i]}\n`;
            });
            csvContent += "\n";

            // Add Vendor Agreement data
            csvContent += "Vendor Agreement Analysis\n";
            csvContent += "Category,Percentage\n";
            chartData.vendorAgreement.data[0].labels.forEach((label, i) => {
                csvContent += `${label},${chartData.vendorAgreement.data[0].values[i]}\n`;
            });

            // Create and trigger download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "ml_dashboard_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add event listener for export button
        document.getElementById('exportAllData').addEventListener('click', exportAllData);

        // Modal functionality
        function openModal(cardId) {
            // [Previous modal code remains the same]
            // ... (keep your existing modal code)
        }

        // Event listeners for modal
        const modal = document.getElementById('chartModal');
        const closeBtn = modal.querySelector('.close');

        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Maximize button listeners
        document.querySelectorAll('.maximize-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const cardId = this.closest('.chart-card').id;
                openModal(cardId);
            });
        });

        // Window resize handler
        window.addEventListener('resize', function() {
            document.querySelectorAll('.chart-content').forEach(chart => {
                Plotly.relayout(chart, {
                    width: chart.clientWidth,
                    height: chart.clientHeight
                });
            });
            
            // Update modal chart if open
            const modalChart = document.querySelector('#modalChartContent > div');
            if (modalChart) {
                Plotly.relayout(modalChart, {
                    width: modalChart.clientWidth,
                    height: modalChart.clientHeight
                });
            }
        });
    });
</script>

<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .export-btn {
        background-color: var(--accent-color);
        color: var(--secondary-bg);
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.3s ease;
    }

    .export-btn:hover {
        background-color: var(--text-color);
    }

    .export-btn i {
        font-size: 1rem;
    }
</style>
{% endblock %}
