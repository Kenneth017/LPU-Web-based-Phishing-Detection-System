{% extends "base.html" %}
{% block content %}
<div class="ml-dashboard">
    <h1>Machine Learning Analytics Dashboard</h1>
    
    <div class="dashboard-grid">
        <!-- Overview Cards -->
        <div class="metric-cards">
            <div class="metric-card">
                <h3>Total Checks</h3>
                <p class="metric-value">{{ basic_metrics.total_checks }}</p>
            </div>
            <div class="metric-card">
                <h3>Detection Rate</h3>
                <p class="metric-value">{{ "%.2f"|format(basic_metrics.detection_rate * 100) }}%</p>
            </div>
            <div class="metric-card">
                <h3>Phishing Detected</h3>
                <p class="metric-value">{{ basic_metrics.phishing_detected }}</p>
            </div>
        </div>

        <!-- ROC Curve -->
        <div class="chart-card" id="rocCurveCard">
            <div class="chart-header">
                <h3>ROC Curve</h3>
                <div class="chart-actions">
                    <button class="download-csv-btn" title="Download CSV">CSV</button>
                    <button class="download-pdf-btn" title="Download PDF">PDF</button>
                    <button class="maximize-btn" title="Maximize">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div id="rocCurve" class="chart-content"></div>
        </div>

        <!-- Precision-Recall Curve -->
        <div class="chart-card" id="prCurveCard">
            <div class="chart-header">
                <h3>Precision-Recall Curve</h3>
                <div class="chart-actions">
                    <button class="download-csv-btn" title="Download CSV">CSV</button>
                    <button class="download-pdf-btn" title="Download PDF">PDF</button>
                    <button class="maximize-btn" title="Maximize">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div id="prCurve" class="chart-content"></div>
        </div>

        <!-- Feature Importance -->
        <div class="chart-card" id="featureImportanceCard">
            <div class="chart-header">
                <h3>Feature Importance Analysis</h3>
                <div class="chart-actions">
                    <button class="download-csv-btn" title="Download CSV">CSV</button>
                    <button class="download-pdf-btn" title="Download PDF">PDF</button>
                    <button class="maximize-btn" title="Maximize">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div id="featureImportance" class="chart-content"></div>
        </div>

        <!-- Model Evolution -->
        <div class="chart-card" id="modelEvolutionCard">
            <div class="chart-header">
                <h3>Model Performance Evolution</h3>
                <div class="chart-actions">
                    <button class="download-csv-btn" title="Download CSV">CSV</button>
                    <button class="download-pdf-btn" title="Download PDF">PDF</button>
                    <button class="maximize-btn" title="Maximize">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div id="modelEvolution" class="chart-content"></div>
        </div>

        <!-- Vendor Agreement -->
        <div class="chart-card" id="vendorAgreementCard">
            <div class="chart-header">
                <h3>Vendor Agreement Analysis</h3>
                <div class="chart-actions">
                    <button class="download-csv-btn" title="Download CSV">CSV</button>
                    <button class="download-pdf-btn" title="Download PDF">PDF</button>
                    <button class="maximize-btn" title="Maximize">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div id="vendorAgreement" class="chart-content"></div>
        </div>
    </div>

    <!-- Modal for displaying charts -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalChartTitle"></h2>
                <span class="close">&times;</span>
            </div>
            <div id="modalChartContent"></div>
        </div>
    </div>
</div>

<!-- Include Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Store the chart data globally
        let chartData = {
            rocCurve: null,
            prCurve: null,
            featureImportance: null,
            modelEvolution: null,
            vendorAgreement: null
        };

        // Initialize main charts
        function initializeCharts() {
            // ROC Curve
            const rocData = {{ performance_graphs.roc_curve|tojson }};
            chartData.rocCurve = {
                data: [{
                    x: rocData.fpr,
                    y: rocData.tpr,
                    type: 'scatter',
                    mode: 'lines',
                    name: `ROC (AUC = ${rocData.auc.toFixed(3)})`,
                    line: {color: '#17BECF'}
                }],
                layout: {
                    title: '',
                    xaxis: {title: 'False Positive Rate'},
                    yaxis: {title: 'True Positive Rate'},
                    margin: {t: 10, r: 10, b: 30, l: 40},
                    height: 200,
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#FFFFFF' }
                }
            };
            Plotly.newPlot('rocCurve', chartData.rocCurve.data, chartData.rocCurve.layout);

            // Precision-Recall Curve
            const prData = {{ performance_graphs.pr_curve|tojson }};
            if (prData && prData.precision && prData.recall) {
                chartData.prCurve = {
                    data: [{
                        x: prData.recall,
                        y: prData.precision,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Precision-Recall',
                        line: {color: '#7F7F7F'}
                    }],
                    layout: {
                        title: '',
                        xaxis: {title: 'Recall', range: [0, 1]},
                        yaxis: {title: 'Precision', range: [0, 1]},
                        showlegend: true,
                        margin: {t: 10, r: 10, b: 30, l: 40},
                        height: 200,
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#FFFFFF' }
                    }
                };
                Plotly.newPlot('prCurve', chartData.prCurve.data, chartData.prCurve.layout);
            }

            // Feature Importance
            const featureData = {{ feature_importance|tojson }};
            const featureImportanceData = [];
            for (const category in featureData) {
                for (const feature in featureData[category]) {
                    featureImportanceData.push({
                        feature: `${category} - ${feature}`,
                        importance: featureData[category][feature]
                    });
                }
            }
            chartData.featureImportance = {
                data: [{
                    x: featureImportanceData.map(d => d.importance),
                    y: featureImportanceData.map(d => d.feature),
                    type: 'bar',
                    orientation: 'h'
                }],
                layout: {
                    title: '',
                    xaxis: {title: 'Importance Score'},
                    yaxis: {
                        title: '',
                        automargin: true,
                        tickfont: {size: 8}
                    },
                    margin: {t: 10, r: 10, b: 30, l: 150},
                    height: 200,
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#FFFFFF' }
                }
            };
            Plotly.newPlot('featureImportance', chartData.featureImportance.data, chartData.featureImportance.layout);

            // Model Evolution
            const evolutionData = {{ model_evolution|tojson }};
            chartData.modelEvolution = {
                data: [{
                    x: evolutionData.dates,
                    y: evolutionData.accuracy,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Accuracy'
                }],
                layout: {
                    title: '',
                    xaxis: {title: 'Date'},
                    yaxis: {title: 'Accuracy'},
                    margin: {t: 10, r: 10, b: 30, l: 40},
                    height: 200,
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#FFFFFF' }
                }
            };
            Plotly.newPlot('modelEvolution', chartData.modelEvolution.data, chartData.modelEvolution.layout);

            // Vendor Agreement
            const vendorData = {{ vendor_agreement|tojson }};
            chartData.vendorAgreement = {
                data: [{
                    values: Object.values(vendorData),
                    labels: Object.keys(vendorData),
                    type: 'pie'
                }],
                layout: {
                    title: '',
                    margin: {t: 10, r: 10, b: 10, l: 10},
                    height: 200,
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#FFFFFF' }
                }
            };
            Plotly.newPlot('vendorAgreement', chartData.vendorAgreement.data, chartData.vendorAgreement.layout);
        }

        // Initialize main charts
        initializeCharts();

        // Download functions
        function downloadCSV(data, filename) {
            const csvContent = "data:text/csv;charset=utf-8," + data.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadPDF(chartDiv, filename) {
            Plotly.downloadImage(chartDiv, {
                format: 'pdf',
                filename: filename,
                height: chartDiv.clientHeight,
                width: chartDiv.clientWidth
            });
        }

        // Modal functionality
        function openModal(cardId) {
            const modal = document.getElementById('chartModal');
            const modalTitle = document.getElementById('modalChartTitle');
            const modalContent = document.getElementById('modalChartContent');
            
            const card = document.getElementById(cardId);
            const title = card.querySelector('h3').textContent;
            const chartDiv = card.querySelector('.chart-content');
            
            modalTitle.textContent = title;
            modal.style.display = "block";
            
            // Clear previous content
            modalContent.innerHTML = '';
            
            // Create a new div for the chart
            const newChartDiv = document.createElement('div');
            newChartDiv.style.width = '100%';
            newChartDiv.style.height = '80vh';
            modalContent.appendChild(newChartDiv);
            
            // Get the chart type from the chart div id
            const chartType = chartDiv.id;
            
            // Create a new layout for the modal
            const modalLayout = {
                ...chartData[chartType].layout,
                height: newChartDiv.clientHeight,
                width: newChartDiv.clientWidth
            };
            
            // Plot the chart in the modal
            Plotly.newPlot(newChartDiv, chartData[chartType].data, modalLayout);
        }

        // Event listeners
        const modal = document.getElementById('chartModal');
        const closeBtn = modal.querySelector('.close');

        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Maximize button listeners
        document.querySelectorAll('.maximize-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const cardId = this.closest('.chart-card').id;
                openModal(cardId);
            });
        });

        // Download button listeners
        document.querySelectorAll('.download-csv-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const cardId = this.closest('.chart-card').id;
                const chartType = cardId.replace('Card', '');
                const data = chartData[chartType].data[0];
                const csvData = [
                    ['x', 'y'],
                    ...data.x.map((x, i) => [x, data.y[i]])
                ];
                downloadCSV(csvData, `${chartType}.csv`);
            });
        });

        document.querySelectorAll('.download-pdf-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const cardId = this.closest('.chart-card').id;
                const chartDiv = document.getElementById(cardId.replace('Card', ''));
                downloadPDF(chartDiv, `${cardId.replace('Card', '')}.pdf`);
            });
        });

        // Window resize handler
        window.addEventListener('resize', function() {
            document.querySelectorAll('.chart-content').forEach(chart => {
                Plotly.relayout(chart, {
                    width: chart.clientWidth,
                    height: chart.clientHeight
                });
            });
            
            // Update modal chart if open
            const modalChart = document.querySelector('#modalChartContent > div');
            if (modalChart) {
                Plotly.relayout(modalChart, {
                    width: modalChart.clientWidth,
                    height: modalChart.clientHeight
                });
            }
        });
    });
</script>
