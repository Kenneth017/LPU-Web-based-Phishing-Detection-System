{% extends "base.html" %}
{% block content %}
<div class="ml-dashboard">
    <div class="dashboard-header">
        <h1>Machine Learning Analytics Dashboard</h1>
        <button id="exportAllData" class="export-btn">
            <i class="fas fa-download"></i> Export Dashboard Data
        </button>
    </div>
    
    <div class="dashboard-grid">
        <!-- Overview Cards -->
        <div class="metric-cards">
            <div class="metric-card">
                <h3>Total Checks</h3>
                <p class="metric-value">{{ basic_metrics.total_checks }}</p>
            </div>
            <div class="metric-card">
                <h3>Detection Rate</h3>
                <p class="metric-value">{{ "%.2f"|format(basic_metrics.detection_rate * 100) }}%</p>
            </div>
            <div class="metric-card">
                <h3>Phishing Detected</h3>
                <p class="metric-value">{{ basic_metrics.phishing_detected }}</p>
            </div>
        </div>

        <!-- ROC Curve -->
        <div class="chart-card" id="rocCurveCard">
            <div class="chart-header">
                <h3>ROC Curve</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="rocCurve" class="chart-content"></div>
        </div>

        <!-- Precision-Recall Curve -->
        <div class="chart-card" id="prCurveCard">
            <div class="chart-header">
                <h3>Precision-Recall Curve</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="prCurve" class="chart-content"></div>
        </div>

        <!-- Feature Importance -->
        <div class="chart-card" id="featureImportanceCard">
            <div class="chart-header">
                <h3>Feature Importance Analysis</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="featureImportance" class="chart-content"></div>
        </div>

        <!-- Model Evolution -->
        <div class="chart-card" id="modelEvolutionCard">
            <div class="chart-header">
                <h3>Model Performance Evolution</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="modelEvolution" class="chart-content"></div>
        </div>

        <!-- Vendor Agreement -->
        <div class="chart-card" id="vendorAgreementCard">
            <div class="chart-header">
                <h3>Vendor Agreement Analysis</h3>
                <button class="maximize-btn" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            <div id="vendorAgreement" class="chart-content"></div>
        </div>
    </div>

    <!-- Modal for displaying charts -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalChartTitle"></h2>
                <span class="close">&times;</span>
            </div>
            <div id="modalChartContent"></div>
        </div>
    </div>

<!-- Include Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded");
        console.log("Plotly available:", typeof Plotly !== 'undefined');
        
        // Store the chart data globally so it's accessible for the modal
        let chartData = {
            rocCurve: null,
            prCurve: null,
            featureImportance: null,
            modelEvolution: null,
            vendorAgreement: null
        };
    
        // Common chart layout settings
        const commonChartLayout = {
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            font: { 
                color: '#FFFFFF',
                family: 'Inter, sans-serif'
            },
            xaxis: {
                gridcolor: 'rgba(255,255,255,0.1)',
                zerolinecolor: 'rgba(255,255,255,0.1)',
                linecolor: 'rgba(255,255,255,0.1)'
            },
            yaxis: {
                gridcolor: 'rgba(255,255,255,0.1)',
                zerolinecolor: 'rgba(255,255,255,0.1)',
                linecolor: 'rgba(255,255,255,0.1)'
            }
        };
    
        function initializeCharts() {
            // ROC Curve
            const rocData = {{ performance_graphs.roc_curve|tojson }};
            chartData.rocCurve = {
                data: [{
                    x: rocData.fpr,
                    y: rocData.tpr,
                    type: 'scatter',
                    mode: 'lines',
                    name: `ROC (AUC = ${rocData.auc.toFixed(3)})`,
                    line: {color: '#17BECF'}
                }],
                layout: {
                    ...commonChartLayout,
                    title: '',
                    xaxis: {
                        ...commonChartLayout.xaxis,
                        title: 'False Positive Rate'
                    },
                    yaxis: {
                        ...commonChartLayout.yaxis,
                        title: 'True Positive Rate'
                    },
                    margin: {t: 10, r: 10, b: 30, l: 40},
                    height: 200
                }
            };
            Plotly.newPlot('rocCurve', chartData.rocCurve.data, chartData.rocCurve.layout);
    
            // Precision-Recall Curve
            const prData = {{ performance_graphs.pr_curve|tojson }};
            if (prData && prData.precision && prData.recall) {
                chartData.prCurve = {
                    data: [{
                        x: prData.recall,
                        y: prData.precision,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Precision-Recall',
                        line: {color: '#7F7F7F'}
                    }],
                    layout: {
                        ...commonChartLayout,
                        title: '',
                        xaxis: {
                            ...commonChartLayout.xaxis,
                            title: 'Recall',
                            range: [0, 1]
                        },
                        yaxis: {
                            ...commonChartLayout.yaxis,
                            title: 'Precision',
                            range: [0, 1]
                        },
                        showlegend: true,
                        margin: {t: 10, r: 10, b: 30, l: 40},
                        height: 200
                    }
                };
                Plotly.newPlot('prCurve', chartData.prCurve.data, chartData.prCurve.layout);
            }
    
            // Feature Importance
            const featureData = {{ feature_importance|tojson }};
            const featureImportanceData = [];
            for (const category in featureData) {
                for (const feature in featureData[category]) {
                    featureImportanceData.push({
                        feature: `${category} - ${feature}`,
                        importance: featureData[category][feature]
                    });
                }
            }
            chartData.featureImportance = {
                data: [{
                    x: featureImportanceData.map(d => d.importance),
                    y: featureImportanceData.map(d => d.feature),
                    type: 'bar',
                    orientation: 'h',
                    marker: {
                        color: '#17BECF'
                    }
                }],
                layout: {
                    ...commonChartLayout,
                    title: '',
                    xaxis: {
                        ...commonChartLayout.xaxis,
                        title: 'Importance Score',
                        tickfont: { size: 10 }
                    },
                    yaxis: {
                        ...commonChartLayout.yaxis,
                        title: '',
                        automargin: true,
                        tickfont: { size: 8 }
                    },
                    margin: {t: 10, r: 10, b: 50, l: 250}, // Increased left margin
                    height: 200,
                    bargap: 0.2,
                    showlegend: false
                }
            };
            
            // Add a small delay for Feature Importance chart
            setTimeout(() => {
                Plotly.newPlot('featureImportance', chartData.featureImportance.data, chartData.featureImportance.layout)
                    .then(() => {
                        Plotly.relayout('featureImportance', { 'autosize': true });
                    });
            }, 100);
            
            // Model Evolution
            const evolutionData = {{ model_evolution|tojson }};
            chartData.modelEvolution = {
                data: [{
                    x: evolutionData.dates,
                    y: evolutionData.accuracy,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Accuracy',
                    line: {
                        color: '#17BECF',
                        width: 2
                    },
                    marker: {
                        size: 8,
                        color: '#17BECF'
                    }
                }],
                layout: {
                    ...commonChartLayout,
                    title: '',
                    xaxis: {
                        ...commonChartLayout.xaxis,
                        title: 'Date',
                        tickangle: -45,
                        tickfont: { size: 10 }
                    },
                    yaxis: {
                        ...commonChartLayout.yaxis,
                        title: 'Accuracy',
                        tickformat: '.2%',
                        range: [0, 1],
                        tickfont: { size: 10 }
                    },
                    margin: {t: 10, r: 30, b: 80, l: 50}, // Increased bottom margin for rotated labels
                    height: 200
                }
            };
            
            // Add a small delay for Model Evolution chart
            setTimeout(() => {
                Plotly.newPlot('modelEvolution', chartData.modelEvolution.data, chartData.modelEvolution.layout)
                    .then(() => {
                        Plotly.relayout('modelEvolution', { 'autosize': true });
                    });
            }, 100);
    
            // Vendor Agreement
            const vendorData = {{ vendor_agreement|tojson }};
            chartData.vendorAgreement = {
                data: [{
                    values: Object.values(vendorData),
                    labels: Object.keys(vendorData),
                    type: 'pie'
                }],
                layout: {
                    ...commonChartLayout,
                    title: '',
                    margin: {t: 10, r: 10, b: 10, l: 10},
                    height: 200
                }
            };
            Plotly.newPlot('vendorAgreement', chartData.vendorAgreement.data, chartData.vendorAgreement.layout);
        }
    
        // Initialize main charts
        initializeCharts();
        setTimeout(ensureChartsVisible, 500);
    
        function refreshDashboardCharts() {
            const charts = ['rocCurve', 'prCurve', 'featureImportance', 'modelEvolution', 'vendorAgreement'];
            charts.forEach(chartType => {
                if (chartData[chartType]) {
                    const chartDiv = document.getElementById(chartType);
                    if (chartDiv) {
                        Plotly.newPlot(chartDiv, chartData[chartType].data, {
                            ...chartData[chartType].layout,
                            ...commonChartLayout,
                            height: 200,
                            autosize: true
                        });
                    }
                }
            });
        }

        // Add this after your refreshDashboardCharts function
        function ensureChartsVisible() {
            const charts = ['featureImportance', 'modelEvolution'];
            charts.forEach(chartId => {
                const chart = document.getElementById(chartId);
                if (chart && !chart.innerHTML.trim()) {
                    if (chartData[chartId]) {
                        Plotly.newPlot(chartId, chartData[chartId].data, chartData[chartId].layout)
                            .then(() => {
                                Plotly.relayout(chartId, { 'autosize': true });
                            });
                    }
                }
            });
        }
    
        // Export all data function
        function exportAllData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add basic metrics
            csvContent += "Basic Metrics\n";
            csvContent += "Metric,Value\n";
            csvContent += "Total Checks," + "{{ basic_metrics.total_checks }}" + "\n";
            csvContent += "Detection Rate," + "{{ '%.2f'|format(basic_metrics.detection_rate * 100) }}" + "\n";
            csvContent += "Phishing Detected," + "{{ basic_metrics.phishing_detected }}" + "\n\n";
        
            // Add ROC Curve data
            csvContent += "ROC Curve Data\n";
            csvContent += "False Positive Rate,True Positive Rate\n";
            chartData.rocCurve.data[0].x.forEach((x, i) => {
                csvContent += x + "," + chartData.rocCurve.data[0].y[i] + "\n";
            });
            csvContent += "\n";
        
            // Add Precision-Recall data
            csvContent += "Precision-Recall Curve Data\n";
            csvContent += "Recall,Precision\n";
            chartData.prCurve.data[0].x.forEach((x, i) => {
                csvContent += x + "," + chartData.prCurve.data[0].y[i] + "\n";
            });
            csvContent += "\n";
        
            // Add Feature Importance data
            csvContent += "Feature Importance Analysis\n";
            csvContent += "Feature,Importance Score\n";
            chartData.featureImportance.data[0].y.forEach((feature, i) => {
                csvContent += feature + "," + chartData.featureImportance.data[0].x[i] + "\n";
            });
            csvContent += "\n";
        
            // Add Model Evolution data
            csvContent += "Model Performance Evolution\n";
            csvContent += "Date,Accuracy\n";
            chartData.modelEvolution.data[0].x.forEach((date, i) => {
                csvContent += date + "," + chartData.modelEvolution.data[0].y[i] + "\n";
            });
            csvContent += "\n";
        
            // Add Vendor Agreement data
            csvContent += "Vendor Agreement Analysis\n";
            csvContent += "Category,Percentage\n";
            chartData.vendorAgreement.data[0].labels.forEach((label, i) => {
                csvContent += label + "," + chartData.vendorAgreement.data[0].values[i] + "\n";
            });
        
            // Create and trigger download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "ml_dashboard_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    
        // Add event listener for export button
        document.getElementById('exportAllData').addEventListener('click', exportAllData);
    
        // Modal functionality
        const modal = document.getElementById('chartModal');
        const modalTitle = document.getElementById('modalChartTitle');
        const modalContent = document.getElementById('modalChartContent');
        const closeBtn = modal.querySelector('.close');
    
        function maximizeChart(cardId) {
            const card = document.getElementById(cardId);
            const title = card.querySelector('h3').textContent;
            const chartType = card.querySelector('.chart-content').id;
    
            modalTitle.textContent = title;
            modal.style.display = "flex";
            modal.classList.add('show');
    
            const newChartDiv = document.createElement('div');
            newChartDiv.style.width = '100%';
            newChartDiv.style.height = '100%';
            modalContent.innerHTML = '';
            modalContent.appendChild(newChartDiv);
    
            // Deep clone the data to prevent reference issues
            const chartDataCopy = JSON.parse(JSON.stringify(chartData[chartType]));
    
            let modalLayout = {
                ...chartDataCopy.layout,
                ...commonChartLayout,
                autosize: false,
                width: modalContent.clientWidth,
                height: modalContent.clientHeight,
                font: {
                    size: 14,
                    color: '#FFFFFF'
                },
                modebar: {
                    bgcolor: 'rgba(0,0,0,0)',
                    color: '#FFFFFF'
                }
            };
    
            // Specific layout adjustments based on chart type
            if (chartType === 'featureImportance') {
                modalLayout = {
                    ...modalLayout,
                    margin: {
                        l: 300,
                        r: 50,
                        t: 50,
                        b: 100
                    },
                    yaxis: {
                        tickfont: { 
                            size: 12,
                            color: '#FFFFFF'
                        },
                        automargin: true,
                        showgrid: true,
                        gridcolor: 'rgba(255,255,255,0.1)'
                    },
                    xaxis: {
                        tickfont: { 
                            size: 12,
                            color: '#FFFFFF'
                        },
                        title: {
                            text: 'Importance Score',
                            font: {
                                size: 14,
                                color: '#FFFFFF'
                            }
                        },
                        showgrid: true,
                        gridcolor: 'rgba(255,255,255,0.1)'
                    },
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent',
                    bargap: 0.2
                };
            } else if (chartType === 'modelEvolution') {
                modalLayout = {
                    ...modalLayout,
                    margin: {
                        l: 80,
                        r: 50,
                        t: 50,
                        b: 100
                    },
                    xaxis: {
                        tickangle: -45,
                        tickfont: {
                            size: 12,
                            color: '#FFFFFF'
                        },
                        title: {
                            text: 'Date',
                            font: {
                                size: 14,
                                color: '#FFFFFF'
                            }
                        },
                        showgrid: true,
                        gridcolor: 'rgba(255,255,255,0.1)'
                    },
                    yaxis: {
                        tickfont: {
                            size: 12,
                            color: '#FFFFFF'
                        },
                        title: {
                            text: 'Accuracy',
                            font: {
                                size: 14,
                                color: '#FFFFFF'
                            }
                        },
                        showgrid: true,
                        gridcolor: 'rgba(255,255,255,0.1)',
                        range: [0, 1]
                    },
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent'
                };
            }
    
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: `${chartType}_chart`,
                    scale: 2
                }
            };
    
            setTimeout(() => {
                Plotly.newPlot(newChartDiv, chartDataCopy.data, modalLayout, config)
                    .then(() => {
                        Plotly.Plots.resize(newChartDiv);
                    })
                    .catch(error => {
                        console.error('Error plotting chart:', error);
                        Plotly.newPlot(newChartDiv, chartDataCopy.data, modalLayout, config);
                    });
            }, 100);
        }
    
        // Modal event listeners
        closeBtn.onclick = () => {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = "none";
                refreshDashboardCharts();
            }, 300);
        };
    
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = "none";
                    refreshDashboardCharts();
                }, 300);
            }
        };
    
        // Maximize button listeners
        document.querySelectorAll('.maximize-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                maximizeChart(this.closest('.chart-card').id);
            });
        });
    
        // Window resize handler
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (modal.style.display === "flex") {
                    const modalChart = modalContent.querySelector('div');
                    if (modalChart) {
                        Plotly.relayout(modalChart, {
                            'width': modalContent.clientWidth,
                            'height': modalContent.clientHeight
                        });
                    }
                } else {
                    refreshDashboardCharts();
                }
            }, 250); // Debounce resize event
        });
    
        // Function to handle window resize
        function handleResize() {
            if (modal.style.display === "flex") {
                const modalChart = modalContent.querySelector('div');
                if (modalChart) {
                    Plotly.relayout(modalChart, {
                        'width': modalContent.clientWidth,
                        'height': modalContent.clientHeight
                    });
                }
            } else {
                refreshDashboardCharts();
            }
        }
    
        // Add event listener for window resize with debounce
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(handleResize, 250);
        });
    
        // Initial call to set up charts
        handleResize();
    });
</script>
{% endblock %}
